<script>
    const dino = document.getElementById('dino');
    const game = document.getElementById('game');
    const gameOver = document.getElementById('gameOver');
    const startButton = document.getElementById('startButton');
    const initialStartButton = document.getElementById('initialStartButton');
    const scoreDisplay = document.getElementById('score');
    const highScoreDisplay = document.getElementById('high-score');
    const gameMusic = document.getElementById('gameMusic');
    const jumpSound = document.getElementById('jumpSound');
    const hitSound = document.getElementById('hitSound');
    const rankImage = document.getElementById('rank');
    const usernameDisplay = document.getElementById('username-display');

    // Fetch username from the Telegram WebApp
    if (window.Telegram?.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.ready();
        const username = tg.initDataUnsafe?.user?.username || 'Guest';
        usernameDisplay.textContent = username;

        // Function to play the welcome message
        function playWelcomeMessage(username) {
            const audio = new Audio(`/speak/${username}`);
            audio.play();
        }

        // Call the function when the page loads
        window.onload = () => {
            playWelcomeMessage(username);
        };
    } else {
        usernameDisplay.textContent = 'Guest';
    }

    let isJumping = false;
    let dinoBottom = 80;
    let jumpHeight = 150;
    let gravity = 5;
    let jumpSpeed = 15;
    let gameSpeed = 5;
    let gameInterval;
    let scoreInterval;
    let score = 0;
    let highScore = localStorage.getItem('highScore') || 0;
    let obstacles = [];

    highScoreDisplay.querySelector('div').textContent = 'High Score: ' + highScore;

    initialStartButton.addEventListener('click', startGame);
    startButton.addEventListener('click', startGame);

    function jump() {
        if (isJumping) return;
        isJumping = true;
        jumpSound.play();
        let peak = dinoBottom + jumpHeight;
        let jumpInterval = setInterval(() => {
            if (dinoBottom >= peak) {
                clearInterval(jumpInterval);
                let fallInterval = setInterval(() => {
                    if (dinoBottom <= 80) {
                        clearInterval(fallInterval);
                        dinoBottom = 80;
                        isJumping = false;
                    }
                    dinoBottom -= gravity;
                    dino.style.bottom = dinoBottom + 'px';
                }, jumpSpeed);
            }
            dinoBottom += gravity;
            dino.style.bottom = dinoBottom + 'px';
        }, jumpSpeed);
    }

    function startGame() {
        dinoBottom = 80;
        score = 0;
        scoreDisplay.textContent = 'Score: ' + score;
        gameOver.style.display = 'none';
        startButton.style.display = 'none';
        initialStartButton.style.display = 'none';
        isJumping = false;
        obstacles.forEach(obstacle => game.removeChild(obstacle));
        obstacles = [];
        document.addEventListener('touchstart', jump);
        gameInterval = setInterval(createObstacle, 2000);
        scoreInterval = setInterval(updateScore, 100);
        gameMusic.play();
    }

    function updateScore() {
        score++;
        scoreDisplay.textContent = 'Score: ' + score;
    }

    function createObstacle() {
        let obstacle = document.createElement('div');
        obstacle.classList.add('obstacle');
        game.appendChild(obstacle);
        obstacles.push(obstacle);
        let obstaclePosition = game.clientWidth;
        obstacle.style.left = obstaclePosition + 'px';

        let obstacleMoveInterval = setInterval(() => {
            if (obstaclePosition <= 0) {
                clearInterval(obstacleMoveInterval);
                game.removeChild(obstacle);
                obstacles = obstacles.filter(ob => ob !== obstacle);
            }

            if (
                obstaclePosition > 50 && obstaclePosition < 100 &&
                dinoBottom < 130
            ) {
                clearInterval(obstacleMoveInterval);
                hitSound.play();
                gameOver.style.display = 'block';
                startButton.style.display = 'block';
                clearInterval(gameInterval);
                clearInterval(scoreInterval);
                document.removeEventListener('touchstart', jump);
                gameMusic.pause();
                gameMusic.currentTime = 0;

                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem('highScore', highScore);
                    highScoreDisplay.querySelector('div').textContent = 'High Score: ' + highScore;
                }
            }

            obstaclePosition -= gameSpeed;
            obstacle.style.left = obstaclePosition + 'px';
        }, 20);
    }

    function moveBackground() {
        let offset = 0;
        setInterval(() => {
            offset -= 0.05;
            game.style.backgroundPosition = offset + 'px 0';
        }, 20);
    }

    moveBackground();
</script>
